{% extends 'base.html' %}
{% load static %}

{% block title %}Order Tracking - BBQ Grill{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8">
            <!-- Order Header -->
            <div class="card mb-4" style="border: 2px solid var(--bbq-gold); background: linear-gradient(135deg, rgba(255, 140, 0, 0.05) 0%, rgba(255, 215, 0, 0.05) 100%);">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-1" style="color: var(--bbq-gold);">Order #{{ order.id|stringformat:"06d" }}</h3>
                            <p class="text-muted mb-0">Placed on {{ order.created_at|date:"M d, Y H:i" }}</p>
                        </div>
                        <div class="text-end">
                            <h4 class="mb-1">${{ order.total_amount }}</h4>
                            <span class="badge" style="background-color: {% if tracking.status == 'delivered' %}#28a745{% elif tracking.status == 'cancelled' %}#dc3545{% elif tracking.status == 'out_for_delivery' %}#17a2b8{% else %}#ffc107{% endif %}; color: white; padding: 8px 12px; font-size: 12px;">
                                {{ tracking.get_status_display }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tracking Timeline -->
            <div class="card mb-4" style="border: 1px solid var(--bbq-gold);">
                <div class="card-header" style="background: linear-gradient(135deg, var(--bbq-charcoal) 0%, var(--bbq-smoke) 100%); color: white;">
                    <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Tracking Status</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% with statuses=tracking.TRACKING_STATUS_CHOICES %}
                            {% for status_key, status_label in statuses %}
                                <div class="timeline-item {% if tracking.status == status_key %}active{% endif %}" style="margin-bottom: 20px;">
                                    <div class="d-flex">
                                        <div class="timeline-marker" style="
                                            width: 40px;
                                            height: 40px;
                                            border-radius: 50%;
                                            background: {% if tracking.status == status_key %}var(--bbq-gold){% elif status_key in 'order_placed,confirmed' %}#28a745{% else %}#e9ecef{% endif %};
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                            color: white;
                                            font-weight: bold;
                                            flex-shrink: 0;
                                        ">
                                            {% if tracking.status == status_key %}<i class="bi bi-check-circle-fill"></i>{% else %}<i class="bi bi-circle-fill" style="font-size: 12px;"></i>{% endif %}
                                        </div>
                                        <div class="ms-3" style="flex: 1;">
                                            <h6 class="mb-1" style="color: {% if tracking.status == status_key %}var(--bbq-gold){% else %}#333{% endif %};">{{ status_label }}</h6>
                                            {% if tracking.status == status_key %}
                                                <p class="text-muted small mb-0">Current Status - Updated {{ tracking.updated_at|timesince }} ago</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if not forloop.last %}
                                        <div style="
                                            margin-left: 19px;
                                            width: 2px;
                                            height: 20px;
                                            background: {% if tracking.status == status_key or status_key in 'order_placed,confirmed' %}#28a745{% else %}#e9ecef{% endif %};
                                        "></div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% endwith %}
                    </div>
                </div>
            </div>

            <!-- Map Section -->
            {% if has_location %}
            <div class="card mb-4" style="border: 1px solid var(--bbq-gold);">
                <div class="card-header" style="background: linear-gradient(135deg, var(--bbq-charcoal) 0%, var(--bbq-smoke) 100%); color: white;">
                    <h5 class="mb-0"><i class="bi bi-map"></i> Live Delivery Map</h5>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="width: 100%; height: 450px; border-radius: 0 0 8px 8px;"></div>
                </div>
                <div class="card-footer" style="background: #f8f9fa; border-top: 1px solid #dee2e6;">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted"><i class="bi bi-geo-alt-fill" style="color: #FF6B6B;"></i> Your Location (Delivery Point)</small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted"><i class="bi bi-geo-alt-fill" style="color: var(--bbq-gold);"></i> Delivery Person Location</small>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info mb-4" style="border-left: 4px solid var(--bbq-gold);">
                <i class="bi bi-info-circle"></i> <strong>Location tracking will be available once your order is out for delivery.</strong>
            </div>
            {% endif %}

            <!-- Order Items -->
            <div class="card" style="border: 1px solid var(--bbq-gold);">
                <div class="card-header" style="background: linear-gradient(135deg, var(--bbq-charcoal) 0%, var(--bbq-smoke) 100%); color: white;">
                    <h5 class="mb-0"><i class="bi bi-bag-check"></i> Order Items</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.items.all %}
                                <tr>
                                    <td>
                                        <strong>{{ item.product.name }}</strong>
                                        {% if item.product.description %}
                                            <br><small class="text-muted">{{ item.product.description|truncatewords:10 }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.quantity }}</td>
                                    <td>${{ item.price }}</td>
                                    <td><strong>${{ item.total_price }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <hr>
                    <div class="text-end">
                        <h5 style="color: var(--bbq-gold);">Total: <strong>${{ order.total_amount }}</strong></h5>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Payment Information -->
            <div class="card mb-4" style="border: 2px solid var(--bbq-gold); background: linear-gradient(135deg, rgba(255, 140, 0, 0.05) 0%, rgba(255, 215, 0, 0.05) 100%);">
                <div class="card-body text-center">
                    <i class="bi bi-credit-card" style="font-size: 2rem; color: var(--bbq-gold);"></i>
                    <h6 class="mt-3 mb-1">Payment Information</h6>
                    {% if order.payments.exists %}
                        {% with payment=order.payments.first %}
                            <div class="mt-3">
                                <span class="badge badge-lg bg-{% if payment.status == 'completed' %}success{% elif payment.status == 'processing' %}info{% elif payment.status == 'pending' %}warning{% elif payment.status == 'failed' %}danger{% elif payment.status == 'refunded' %}dark{% else %}secondary{% endif %}" style="padding: 8px 12px; font-size: 14px;">
                                    {{ payment.get_status_display }}
                                </span>
                                <p class="mt-2 mb-1"><strong>Method:</strong> {{ payment.get_payment_method_display }}</p>
                                <p class="mb-1"><strong>Amount:</strong> ₱{{ payment.amount }}</p>
                                {% if payment.payment_date %}
                                    <p class="mb-1"><strong>Paid:</strong> {{ payment.payment_date|date:"M d, Y H:i" }}</p>
                                {% endif %}
                                {% if payment.transaction_id %}
                                    <p class="mb-1"><strong>Transaction ID:</strong> <small>{{ payment.transaction_id }}</small></p>
                                {% endif %}
                                {% if payment.reference_number %}
                                    <p class="mb-0"><strong>Reference:</strong> <small>{{ payment.reference_number }}</small></p>
                                {% endif %}
                            </div>
                        {% endwith %}
                    {% else %}
                        <p class="text-muted mt-3">No payment information available</p>
                    {% endif %}
                </div>
            </div>

            <!-- Estimated Delivery -->
            <div class="card mb-4" style="border: 2px solid var(--bbq-gold); background: linear-gradient(135deg, rgba(255, 140, 0, 0.05) 0%, rgba(255, 215, 0, 0.05) 100%);">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-event" style="font-size: 2rem; color: var(--bbq-gold);"></i>
                    <h6 class="mt-3 mb-1">Estimated Delivery</h6>
                    {% if tracking.estimated_delivery %}
                        <p class="mb-0" style="color: var(--bbq-gold); font-weight: bold;">
                            {{ tracking.estimated_delivery|date:"M d, Y H:i" }}
                        </p>
                    {% else %}
                        <p class="text-muted mb-0">To be determined</p>
                    {% endif %}
                </div>
            </div>

            <!-- Delivery Location Info -->
            <div class="card mb-4" style="border: 1px solid var(--bbq-gold);">
                <div class="card-header" style="background: linear-gradient(135deg, var(--bbq-charcoal) 0%, var(--bbq-smoke) 100%); color: white;">
                    <h6 class="mb-0"><i class="bi bi-geo-alt-fill" style="color: #FF6B6B;"></i> Your Delivery Location</h6>
                </div>
                <div class="card-body">
                    {% if order.delivery_address %}
                        <p class="mb-2"><strong>Address:</strong></p>
                        <p class="mb-3" style="color: #666;">{{ order.delivery_address }}</p>
                    {% endif %}
                    {% if order.delivery_barangay %}
                        <p class="mb-2"><strong>Barangay:</strong></p>
                        <p class="mb-0" style="color: #666;">{{ order.delivery_barangay }}, Naval, Biliran</p>
                    {% endif %}
                </div>
            </div>

            <!-- Current Location Info -->
            {% if tracking.location_name %}
            <div class="card mb-4" style="border: 1px solid var(--bbq-gold);">
                <div class="card-header" style="background: linear-gradient(135deg, var(--bbq-charcoal) 0%, var(--bbq-smoke) 100%); color: white;">
                    <h6 class="mb-0"><i class="bi bi-geo-alt-fill" style="color: var(--bbq-gold);"></i> Delivery Person Location</h6>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ tracking.location_name }}</p>
                    {% if tracking.latitude and tracking.longitude %}
                        <small class="text-muted d-block mt-2">
                            <i class="bi bi-pin-map"></i> {{ tracking.latitude|floatformat:4 }}, {{ tracking.longitude|floatformat:4 }}
                        </small>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Contact Support -->
            <div class="card" style="border: 1px solid var(--bbq-gold);">
                <div class="card-body">
                    <h6 class="mb-3"><i class="bi bi-headset" style="color: var(--bbq-gold);"></i> Need Help?</h6>
                    <p class="small mb-3">If you have any questions about your order, please contact our support team.</p>
                    <a href="{% url 'feedback' %}" class="btn btn-sm" style="background: var(--bbq-gold); color: white; border: none;">
                        <i class="bi bi-chat-dots"></i> Contact Support
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="mt-4">
        <a href="{% url 'order_list' %}" class="btn" style="background: var(--bbq-charcoal); color: white;">
            <i class="bi bi-arrow-left"></i> Back to Orders
        </a>
    </div>
</div>

<!-- Leaflet Map Library -->
{% if has_location %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get coordinates
        const deliveryLat = {{ tracking.latitude }};
        const deliveryLng = {{ tracking.longitude }};
        const customerLat = {{ tracking.customer_latitude|default:"11.5667" }};
        const customerLng = {{ tracking.customer_longitude|default:"124.5667" }};
        
        // Center map between both locations
        const centerLat = (deliveryLat + customerLat) / 2;
        const centerLng = (deliveryLng + customerLng) / 2;
        
        const map = L.map('map').setView([centerLat, centerLng], 14);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Add marker for delivery person (gold)
        L.marker([deliveryLat, deliveryLng], {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).bindPopup('<strong>Delivery Person</strong><br>Order #{{ order.id|stringformat:"06d" }}<br>{{ tracking.location_name }}').addTo(map);
        
        // Add marker for customer location (red)
        L.marker([customerLat, customerLng], {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).bindPopup('<strong>Your Delivery Location</strong><br>{{ order.delivery_address }}<br>{{ order.delivery_barangay }}').addTo(map);
        
        // Draw a line between delivery person and customer
        const line = L.polyline([
            [deliveryLat, deliveryLng],
            [customerLat, customerLng]
        ], {
            color: '#D4AF37',
            weight: 2,
            opacity: 0.7,
            dashArray: '5, 5'
        }).addTo(map);
        
        // Fit map to show both markers
        const group = new L.featureGroup([
            L.marker([deliveryLat, deliveryLng]),
            L.marker([customerLat, customerLng])
        ]);
        map.fitBounds(group.getBounds().pad(0.1));
    });
</script>
{% endif %}

<style>
    .timeline {
        position: relative;
    }

    .timeline-item {
        opacity: 0.6;
        transition: all 0.3s ease;
    }

    .timeline-item.active {
        opacity: 1;
    }

    .timeline-marker {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .timeline-item.active .timeline-marker {
        box-shadow: 0 0 20px rgba(255, 140, 0, 0.5);
        transform: scale(1.1);
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
</style>
{% endblock %}
